<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>Title</title>
</head>
<body>
    <h2>상품 목록</h2>
    <!-- 검색 -->
    <form id="searchForm" onsubmit="return false;" autocomplete="off">
        <div>
            <select title="검색 유형 선택">
                <option value="">전체 검색</option>
                <option value="">제목</option>
                <option value="">내용</option>
            </select>
            <input type="text" placeholder="어디로 갈까요?" title="검색"/>
            <button type="button"><span>검색</span></button>
        </div>
    </form>

    <!-- 목록 영역 -->
    <div id="list"></div>
    <!-- 페이지네이션 -->
    <div class="paging"></div>

    <a th:href="@{/product/productWrite}">상품 등록</a>

</body>

<script th:inline="javascript">
    /*<![CDATA[*/

    window.onload = () => {
        findAllProduct();
    }

    //게시글 리스트 조회
    function findAllProduct() {
        //ProductPagingResponse의 list
        const list = [[${response.list}]];
        //값 없으면 메시지
        if (!list.length) {
            document.getElementById('list').innerHTML = '<div>검색된 결과가 없습니다.</div>';
            drawPage();
        }
        //ProductPagingResponse의 productPagination(response는 컨트롤러)
        const pagination = [[${response.productPagination}]];
        //@ModelAttribute ProductSearch의 params
        const params = [[${params}]];
        //게시글 번호 처리
        let num = pagination.totalRecordCount - ((params.page - 1) * params.recordSize);
        //리스트 렌더링
        drawList(list, num);
        //페이지 번호 렌더링
        drawPage(pagination, params);
    }

    //리스트 HTML
    function drawList(list, num) {
        console.log(list);
        //HTML 저장 변수
        let html = '';
        //(전체 데이터 수 - ((현재 페이지 번호 - 1) * 페이지당 출력할 데이터 개수))
        list.forEach(row => {

            const startDate = new Date(row.tour_START);
            const endDate = new Date(row.tour_END);

            //날짜 포맷
            const formattedStartDate = `${startDate.getFullYear()}-${(startDate.getMonth() + 1).toString().padStart(2, '0')}-${startDate.getDate().toString().padStart(2, '0')}`;
            const formattedEndDate = `${endDate.getFullYear()}-${(endDate.getMonth() + 1).toString().padStart(2, '0')}-${endDate.getDate().toString().padStart(2, '0')}`;

            html += `
                    <div><b>상품명:</b><a href="/product/productView?PRO_ID=${row.pro_ID}">${row.pro_NAME}</a></div>
                    <div><b>카테고리:</b>${row.pro_CATEGORY_TOTAL}</div>
                    <div><b>분류:</b>${row.pro_CATEGORY_DETAIL}</div>
                    <div><b>지역:</b>${row.pro_LOCATION}</div>
                    <div><b>가격:</b>${row.pro_PRICE}</div>
                    <div><b>소요일:</b>${row.tour_DATE}</div>
                    <div><b>소요시간:</b>${row.tour_TIME}</div>
                    <div><b>판매시작:</b>${formattedStartDate}</div>
                    <div><b>판매종료:</b>${formattedEndDate}</div>
                `;
        })
        //list 요소 HTML 배치
        document.getElementById('list').innerHTML = html;
    }

    // 페이지 HTML
    function drawPage(pagination, params) {
        //파라미터가 없는 경우, 페이지 번호 제거
        if ( !pagination || !params ) {
            document.querySelector('.paging').innerHTML = '';
            throw new Error('없슈');
        }
        //HTML 저장
        let html = '';
        // 시작 페이지(startPage)가 1이 아닌 경우 시작 페이지 버튼, 이전 페이지 버튼 추가
        if (pagination.existPrevPage) {
            html += `
                    <a href="javascript:void(0);" onclick="movePage(1)" class="page_bt first">시작 페이지</a>
                    <a href="javascript:void(0);" onclick="movePage(${pagination.startPage - 1})" class="page_bt prev">이전 페이지</a>
                `;
        }
        //시작 페이지 마지막 페이지 사이 페이지 번호 넘버링
        html += '<p>';
        for (let i = pagination.startPage; i <= pagination.endPage; i++) {
            html += (i !== params.page)
                ? `<a href="javascript:void(0);" onclick="movePage(${i});">${i}</a>`
                : `<span class="on">${i}</span>`
        }
        html += '</p>';
        //다음 페이지 버튼과 끝 페이지 버튼 추가
        if (pagination.existNextPage) {
            html += `
                    <a href="javascript:void(0);" onclick="movePage(${pagination.endPage + 1});" class="page_bt next">다음 페이지</a>
                    <a href="javascript:void(0);" onclick="movePage(${pagination.totalPageCount});" class="page_bt last">마지막 페이지</a>
                `;
        }
        //class "paging"인 요소 렌더링
        document.querySelector('.paging').innerHTML = html;
    }

    //페이지 이동
    function movePage(page) {
        //drawPage( ) onclick 이벤트를 통해 전달받은 페이지 번호로 객체 생성
        const queryParams = {
            page: (page) ? page : 1,
            recordSize: 5,
            pageSize: 5
        }
        //location.pathname: product/list.do
        //new URLSearchParams(queryParams).toString() : queryParams의 모든 프로퍼티(key-value) 쿼리 스트링으로 변환
        location.href = location.pathname + '?' + new URLSearchParams(queryParams).toString();
    }

    /*]]>*/
</script>

</html>